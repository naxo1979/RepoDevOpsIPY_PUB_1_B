pipeline {
    agent any
    
    stages {
        stage('Get Code'){
            steps {
                // get code from repo
                bat '''
                    whoami
                    hostname
                '''
                echo WORKSPACE
                git 'https://github.com/naxo1979/RepoDevOpsIPY_PUB_1_B'
            }
        }
    
		stage('Unit') {
            steps {
                bat '''
                    whoami
                    hostname
                '''
                        echo WORKSPACE
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {        
                            bat '''
                                SET PYTHONPATH=%WORKSPACE%
                                pytest --junitxml=result-unit.xml test\\unit
                            '''
                        }
                    }
		}
		
		stage('Coverage') {
            steps {
                bat '''
                    coverage run --branch --source=app --omit=app\\init.py,app\\api.py -m pytest test\\unit
                    coverage xml
                '''
                cobertura(
                    coberturaReportFile: 'coverage.xml', 
                    conditionalCoverageTargets: '100,80,95', 
                    failUnstable: false
                )
			}
		}
	}
}	
